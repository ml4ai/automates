### Introduction

The scripts in this directory support batch decoding of latex from PNG images of equations (`batch_decode_eq_images.py`), as well as provide help with creating equation image corpora from latext (`render_eq_img_from_latex.py`) and comparing images (where the images presumably were manually created and then decoded using `eqdec`: `compare_decoded.py`).

The scripts are currently set up to expect a path to a local version of the AutoMATES Google Drive Data root. This path is set in each script by the global var `ASKE_GOOGLE_DRIVE_DATA_ROOT`, but can be specified either by (1) creating a file called `config.json` that has the following content:

```
{
  "AUTOMATES_DATA": <string of absolute path to Google Drive ASKE-Automates/Data>
}
```
(Note: config.json is .gitignore'd in the `scripts/equation_reading/ directory`)

... or (2) you can specify this as a user environment variable (e.g., in your .zshrc/.bashrc).

The following is the procedure for manually creating latex source for equations and then using the three scripts to create source PNGs, decode them to latex, make PNGs of those, and the create the summary comparison html. See the next section, _Common Directory Structure_, for the general directory structure assumed by the escripts; specific files that are created (by you) or generated (by the scripts) are referred to in the following steps.

1. Create manual latex source for all of the equations. I do this in a single file: `<source_paper_filename>.tex` (noted below in the _Common Directory Structure_ with the tag *1; You can use the already existing PETPT and PETASCE versions of this file as a template).
2. After creating the latex for each equation, I then copy just the latex source for each equation so that they take up just one line each in `<model>_equations.txt` (indicated below in _Common Directory Structure_ with the tag *2), in order of the equation number (maintaining the order is important as the current scheme does not have an explicit representation of the equation number/id).
3. With `<model>_equations.txt` filled in, now you can run the script in the `automates` repo: `scripts/equation_reading/render_eq_img_from_latex.py`. See the script for usage instructions as well as what it produces. The result is a set of numbered PNG files saved in `<model>/manual_eqn_images/` (noted below in the _Common Directory Structure_ with the tag *3). You will need ImageMagick and pdflatex installed.
4. Now that the PNG files are available, you can run the script `scripts/equation_reading/batch_decode_eq_images.py`. To run this, you must have the [eqdec app installed and running](https://github.com/ml4ai/automates/blob/master/automates/equation_reading/equation_translation/eqdec/readme.txt). The script will batch process the `<model>/manual_eqn_images/` PNGs, attempting to extract latex from the images, and then running a version of the previous script (`render_eq_img_from_latex.py`) to generate PNGs from the extracted latex. The extracted and rendered PNGs are saved in `<model>/decoded_images/` (noted below in the _Common Directory Structure_ with the tag *4).
5. Now that both (a) the manual source equation PNGs and (b) the decoded equation PNGs have been generated, the last script will construct a webpage comparing the (a) and (b) images per row, grouped by source paper (per model). The script `scripts/equation_reading/compare_decoded.py` generates the file comparison.html in the parent `PET` directory (as indicated in the _Common Directory Structure_ with tag *5). NOTE: that after you complete steps 1-4 for a given model, you must then add that model root to the sequence assigned to `COMPARISON_SPEC` in `compare_decoded.py`.


### Common Directory Structure
The following is the relevant directory structure for the Mini-SPAM equation Data in the AutoMATES Google Drive.

```
ASKE-AutoMATES/Data/Mini-SPAM/
  docs/SPAM/PET/
  	# Location of paper sources for each of the 6 PET models
  eqns/SPAM/PET/
    # Location of equation output for each model
    # <model> := {PETASCE, PETDYN, PETMEY, PETPEN, PETPNO, PETPT}
*5  comparison.html  # generated by script, comparing input source image and decoded eqn output
    <model>/
*4    decoded_images/  # location for all files from running image to latex decoder (eqdec)
        <#>.png  # image rendered from decoded latex
        decoded_equations.txt  # text file containing one equation latex source per line; result from eqdec
        json/  # directory containing json output (for each eqn) resulting from running eqdec
        tex/  # contains .tex source and pdflatex-generated .pdf for each line in decoded_equations.txt
*3    manual_eqn_images/  # eqn images generated from manual latex source using the `standalone` environment
        <#>.png  # image rendered from manually-generated latex
      manual_latex /  # location for all files from creating manual latex implementations of each equation
*1      <source_paper_filename>.tex
        tex/  # contains .tex source and pdflatex-generated .pdf for each line in <model>_equations.txt
        manual_crop_direct_clips/  # Ignore this (only shows up so far in PETPT; manual cropped images from original source paper pdfs)
*2    <model>_equations.txt  # text file containing one latex source per line; from manual eqn latex
```


### Paper source pdf filenames (and locations) for each model
(* indicates manual latex generation is done and all generation scripts have been run)

```
(*) PETPT —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petpt_2012.pdf
(*) PETASCE —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petasce.pdf
(*) PETPNO —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petpno_Penman.pdf
(*) PETPEN —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petpen_PM.pdf
(*) PETDYN —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petdyn_modern.pdf
(*) PETMEY —> ASKE-AutoMATES/Data/Mini-SPAM/docs/SPAM/PET/petmey.pdf
```
