### Analyzing Fortran Source Programs: for2py

`for2py` is a front-end translator that maps Fortran source programs to
a language-independent program analysis intermediate representation
(PAIR) that is then used to generate files used as input to subsequent
analysis. The PAIR currently consists of Python data structures
representing the abstract syntax of the input code, together with
comments extracted from the source files, that are saved as pickled
Python files.  The output generated by `for2py` includes GrFN JSON files
and representations of modular computations from the source code being
analyzed (*Lambdas*).

The `for2py` pipeline is implemented within the public
[Delphi](https://github.com/ml4ai/delphi) project, under the
[delphi/program_analysis/](https://github.com/ml4ai/delphi/tree/master/delphi/program_analysis)
sudirectory.

### Program Analysis Intermediate Representation

While `for2py` targets programs written in Fortran, the PAIR to which it
maps the source code aims to avoid language-specific assumptions. An
important design principle for our PAIR is to retain, as much as possible,
the high-level computational structure of the input code while
abstracting away language-specific details. Retaining the high-level
computational structure of input programs makes it easier to perform
high-level qualitative analyses and to connect information about
constructs in the input code, e.g., variables or subprograms, with the
results of analyses of text documents  and equations.  The
language-independent nature of the PAIR makes it possible (in principle)
to analyze models that may have been implemented using multiple source
languages, and also to reason about and compare models written in
different programming languages.

### Processing Pipeline

The translation process in `for2py` is organized as the following
pipeline:

1. **Input processing.** [Language-dependent; currently
   Fortran-specific.] The source code is read in and analyzed to
   produce an program analysis intermediate representation (PAIR).
   This consists of the following steps:

   1. *Preprocessing and comment extraction.*  Preprocessing involves
      cleaning up or transforming source language constructs to make
      subsequent parsing easier and more robust.  Comment extraction
      aims to get around the fact that most language parsers are
      implemented as compiler front-ends and therefore discard comments.

   2. *Parsing.*  For2py uses the [Open Fortran Parser
      (OFP)](https://github.com/OpenFortranProject/open-fortran-parser)
      to parse the Fortran source code into an *abstract syntax tree*
      (AST) representation that is then written out as an XML file.

   3. *Integration and translation to PAIR.* The AST is read in from
      the XML files created by OFP.  Various tree transformations are
      applied: both to abstract away a number of language-specific
      details (e.g., the way in which function return values are
      indicated in Fortran), and also to address some bugs in OFP. The
      transformed ASTs are integrated with comments extracted in the
      first step listed above. In addition to this, the entry-points
      for the Fortran source file are determined and the resulting PAIR
      is then serialized to a Python
      [pickle](https://docs.Python.org/3/library/pickle.html) file.
      (Note: the API permits bypassing this step if caching of
      intermediate results is not needed - for example while analyzing
      smaller programs.)

2. **Output generation.**  [Language-independent.]  The files containing
   the pickled Python PAIR objects are read in and processed to generate
   the following output files:

    1. Modular functional encodings of how program variables are
       computed as a function of other variables (*Lambdas*) 
    2. [GrFN JSON](GrFN_specification_v0.1) files 
    3. A Python script equivalent in functionality to the Fortran file 
       being translated (and used to verify functional behavior 
       equivalency with original source code)
	
The separation of the input processing and output generation into two
distinct steps is motivated by the following design considerations:

1. *Performance and scalability.*  Modules that are referenced by
   multiple program components do not have to be reanalyzed separately
   for each referencing component.  Independent source-language modules
   can, in principle, be analyzed concurrently.
2. *Support for source-language heterogeneity.*  This design makes it
   possible, in principle, to support programs with different components
   written in different languages.  It also allows us to reason about
   models implemented in different source languages.
3. *Independence of back-end tasks.*  Different back-end analysis tasks,
   e.g., sensitivity analysis and comment analysis, can be carried out
   independently (and, if necessary, concurrently) on the PAIR.


### Scripts 

`for2py` currently uses the following [scripts](https://github.com/ml4ai/delphi/tree/master/delphi/program_analysis/autoTranslate/scripts):

1. **Input processing.**
* `for2py_pp.py`: pre-processes input Fortran files.
* `get_comments.py`: extracts comments from Fortran files.
* `fortran_syntax.py`: handles a number of Fortran language constructs.
* `fortran_format.py`: processes Fortran I/O formatting.
* `translate.py`: processes and transforms the XML files generated by
  OFP, integrates comments obtained from `get_comments.py`, and writes
  out the resulting IR as a pickled Python object.

2. **Output generation.** 
* `pyTranslate.py`: translates the pickled Python object into a fully
   working Python script which is equivalent in function to the original
   Fortran file.
* `genPGM.py`: Reads in the converted Python script to generate the GrFN
               JSON file. 
* `genCode.py`: Works in conjunction with `genPGM.py` to create the
               `lambdas.py` files for subsequent processing.

### Off-the-shelf components

`for2py` currently uses the following off-the-shelf components:

* [Open Fortran Parser](https://github.com/OpenFortranProject/open-fortran-parser).
  This is an open-source Fortran parser that translates Fortran source
  programs to ASTs written out as XML files.  This component can be
  replaced by other software of similar functionality.


### Components we are building

Components we are building consist of the following:

1. *Comment extraction.*  We currently extract subprogram-level comments
   at the heads (i.e., immediately before the beginning of the
   subprogram code), necks (immediately after the subprogram definition
   but before its body), and feet (immediately after the end of the
   subprogram code) of subprograms.

2. *Fortran I/O translation.*  This is important for validation of the
   translation process, since it allows us to map the input Fortran code
   to Python code whose execution behavior can be compared with that of
   the original Fortran program.  We currently handle the I/O constructs
   in the
   [`SimpleModular`](https://github.com/ml4ai/delphi/tree/master/delphi/program_analysis/autoTranslate/tests/test_data/joshua_toy_examples) crop model.

3. *Fortran language processing.*  We currently handle single-file
   programs that do not use Fortran's MODULE construct.  Control flow
   constructs such as subprograms (subroutines and functions),
   conditionals, loops, and case statements are all handled.


### Algorithms 

Algorithms currently being used or developed in `for2py` include the
following:

* *Regular expression construction and matching.*:
  Regular-expression-based pattern matching is used in a number of
  places in lexical analysis of Fortran code, including comment
  processing and I/O format processing.
* *Tree traversals and transformations.*: Pre-order and post-order tree
  traversals are used for analyzing and transforming program ASTs.
